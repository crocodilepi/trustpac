dimension 3
# PARALLEL OK 2 #
Domaine dom_all
Domaine dom_psi
Domaine dom_phi
Domaine dom_T
Domaine dom_ci_anode
Domaine dom_ci_cathode
Domaine dom_C_H2
Domaine dom_C_O2
Domaine dom_C_N2
Domaine dom_C_H2O
Domaine dom_Cooling
Domaine dom_CHa
Domaine dom_CHc
# BEGIN MESH #
Lire_med family_names_from_group_names dom_psi dom_psi dom_psi.med
transformer dom_psi x*0.001000 y*0.001000 z*0.001000
Read_file dom_psi_ssz.geo ;
Lire_med family_names_from_group_names dom_phi dom_phi dom_phi.med
transformer dom_phi x*0.001000 y*0.001000 z*0.001000
Read_file dom_phi_ssz.geo ;
Lire_med family_names_from_group_names dom_T dom_T dom_T.med
transformer dom_T x*0.001000 y*0.001000 z*0.001000
Read_file dom_T_ssz.geo ;
# END MESH #
# BEGIN PARTITION
Lire_med family_names_from_group_names dom_all dom_all dom_all.med
transformer dom_all x*0.001000 y*0.001000 z*0.001000
Read_file dom_all_ssz.geo ;
Partition dom_all {
    Partition_tool tranche { tranches 2 1 1 }
    periodique 1 I_Periodic
    Ecrire_decoupage dom_all.dec
    zones_name dom_all
}
Partition dom_psi {
    Partition_tool partition { domaine dom_all fichier_decoupage dom_all.dec }
    periodique 1 I_Periodic
    zones_name dom_psi
}
Partition dom_phi {
    Partition_tool partition { domaine dom_all fichier_decoupage dom_all.dec }
    zones_name dom_phi
}
Partition dom_T {
    Partition_tool partition { domaine dom_all fichier_decoupage dom_all.dec }
    periodique 1 I_Periodic
    zones_name dom_T
}
END
END PARTITION #
# BEGIN SCATTER
Scatter dom_psi.Zones dom_psi
Sous_Zone dom_psi_GDLa
Associate dom_psi_GDLa dom_psi
Read dom_psi_GDLa { Fichier dom_psi_GDLa.ssz }
Sous_Zone dom_psi_MPLa
Associate dom_psi_MPLa dom_psi
Read dom_psi_MPLa { Fichier dom_psi_MPLa.ssz }
Sous_Zone dom_psi_CLa
Associate dom_psi_CLa dom_psi
Read dom_psi_CLa { Fichier dom_psi_CLa.ssz }
Sous_Zone dom_psi_CLc
Associate dom_psi_CLc dom_psi
Read dom_psi_CLc { Fichier dom_psi_CLc.ssz }
Sous_Zone dom_psi_MPLc
Associate dom_psi_MPLc dom_psi
Read dom_psi_MPLc { Fichier dom_psi_MPLc.ssz }
Sous_Zone dom_psi_GDLc
Associate dom_psi_GDLc dom_psi
Read dom_psi_GDLc { Fichier dom_psi_GDLc.ssz }

Scatter dom_phi.Zones dom_phi
Sous_Zone dom_phi_CLa
Associate dom_phi_CLa dom_phi
Read dom_phi_CLa { Fichier dom_phi_CLa.ssz }
Sous_Zone dom_phi_MB
Associate dom_phi_MB dom_phi
Read dom_phi_MB { Fichier dom_phi_MB.ssz }
Sous_Zone dom_phi_CLc
Associate dom_phi_CLc dom_phi
Read dom_phi_CLc { Fichier dom_phi_CLc.ssz }

Scatter dom_T.Zones dom_T
Sous_Zone dom_T_GDLa
Associate dom_T_GDLa dom_T
Read dom_T_GDLa { Fichier dom_T_GDLa.ssz }
Sous_Zone dom_T_MPLa
Associate dom_T_MPLa dom_T
Read dom_T_MPLa { Fichier dom_T_MPLa.ssz }
Sous_Zone dom_T_CLa
Associate dom_T_CLa dom_T
Read dom_T_CLa { Fichier dom_T_CLa.ssz }
Sous_Zone dom_T_MB
Associate dom_T_MB dom_T
Read dom_T_MB { Fichier dom_T_MB.ssz }
Sous_Zone dom_T_CLc
Associate dom_T_CLc dom_T
Read dom_T_CLc { Fichier dom_T_CLc.ssz }
Sous_Zone dom_T_MPLc
Associate dom_T_MPLc dom_T
Read dom_T_MPLc { Fichier dom_T_MPLc.ssz }
Sous_Zone dom_T_GDLc
Associate dom_T_GDLc dom_T
Read dom_T_GDLc { Fichier dom_T_GDLc.ssz }
Sous_Zone dom_T_Bipo
Associate dom_T_Bipo dom_T
Read dom_T_Bipo { Fichier dom_T_Bipo.ssz }

END SCATTER #

Pb_Conduction pb_phi
Pb_Conduction pb_psi
Pb_Conduction pb_T
VEFPrep1B dis

Schema_Temps_PEMFC_AME sch_pemfc_ame
Read sch_pemfc_ame
{
    tinit 0.
    tmax 10
    nb_pas_dt_max 1
    dt_min 1e-15
    dt_max 1
    dt_impr 0.001
    dt_sauv 400.
    # solver gmres { diag seuil 1e-8 nb_it_max 50 impr } # # does not seem to work well on this system #
    solverPhiPsi petsc cholesky { } # Cholesky is the fastest for sequential simulation and small meshes, 1s @ 60000 ddl #
    # solverPhiPsi petsc gcp { precond spai { } seuil 1e-9 impr } # # 3.9s@60000ddl #
    # solverPhiPsi petsc gcp { precond diag { } seuil 1e-9 impr } # # 3.3s@60000ddl #
    # solverPhiPsi petsc gcp { precond boomeramg { } seuil 1e-9 impr } # # 3.2s@60000ddl #
    facsec 1e4
    name_coupled_problem pbc
}
Schema_Temps_PEMFC_AME sch_disabled
Read sch_disabled
{
    tinit 0.
    tmax 10
    nb_pas_dt_max 1
    dt_min 1e-15
    dt_max 1
    dt_impr 0.001
    dt_sauv 400.
    solverPhiPsi petsc cholesky { }
    facsec 1e4
    name_coupled_problem disabled
}
# Empty time scheme for T #
Schema_Euler_Explicite sch_T { }

# proprietaire pour le transport ionique #
Solide prop_phi
Read prop_phi
{
    rho     champ_uniforme 1 1.
    Cp      champ_uniforme 1 1.
      # this is a uniform isotropic conduction field. #
      # In 2D: diffusion matrix is [[ a b ] [b a ]] => encoded [a b b a] #
      # In 3D: diffusion matrix is
        [[ a b c ]
         [ d e f ]
         [ g h i  ]] => encoded [a b c d e f g h i ] #
    lambda  champ_uniforme_morceaux dom_phi 9 {
        defaut
            6. 0  0
            0  6 0
            0  0  6
        dom_phi_CLa
            0.8 0  0
            0  0.8 0
            0  0  0.8
        dom_phi_CLc
            0.8  0   0
            0   0.8  0
            0    0   0.8  }
}

# couplage de conductivite kappa, courant Ii = kappa.gradT, laplacien Di = div(kappa.gradT) avec T,  C_H2O #
Loi_Fermeture_transport_ionique loi_trans_ion
associer pb_phi loi_trans_ion

# Electronic transport properties #
Solide prop_psi
Read prop_psi
{
    rho     champ_uniforme 1 1.
    Cp      champ_uniforme 1 1.
    lambda  champ_uniforme_morceaux dom_psi 9 {
        defaut      20.000000 0 0  0 20.000000 0  0 0 20.000000
        dom_psi_CLc 20.000000 0 0  0 20.000000 0  0 0 20.000000
        dom_psi_GDLa 100.000000 0 0  0 100.000000 0  0 0 100.000000
        dom_psi_GDLc 100.000000 0 0  0 100.000000 0  0 0 100.000000
        dom_psi_MPLa 100.000000 0 0  0 100.000000 0  0 0 100.000000
        dom_psi_MPLc 100.000000 0 0  0 100.000000 0  0 0 100.000000
    }
}

# dummy properties #
Solide prop_T
Read prop_T
{
    rho     champ_uniforme 1 1.
    Cp      champ_uniforme 1 1.
    lambda  champ_uniforme 1 1.
}

Associate pb_phi dom_phi
Associate pb_phi prop_phi

Associate pb_psi dom_psi
Associate pb_psi prop_psi

Associate pb_T dom_T
Associate pb_T prop_T

Problem_PEMFC pbc
Associate pbc pb_phi
Associate pbc pb_psi
Associate pbc pb_T

Associate pb_phi sch_pemfc_ame
Associate pb_psi sch_disabled
Associate pb_T   sch_T

Discretize pbc dis

Read loi_trans_ion
{
   T_0 		353.15		# default value #
   CSO3 	2036.
   por_naf champ_uniforme_morceaux dom_phi 1 { defaut 0.0 dom_phi_CLa 0.47 dom_phi_CLc 0.47 }	# porosite de Nafion : CL 0.47, MB 0 #
   eps_naf champ_uniforme_morceaux dom_phi 1 { defaut 1. dom_phi_CLa 0.2 dom_phi_CLc 0.2	}	# ionomer proportionnel de Nafion: CA 0.2, MB 1 #
   tor_naf champ_uniforme_morceaux dom_phi 1 { defaut 1. dom_phi_CLa 1.5 dom_phi_CLc 1.3	}		# tortuosite de Nafion #
   nom_ssz_CLc dom_phi_CLc
   nom_ssz_CLa dom_phi_CLa
   nom_pb_T 	pb_T
   nom_champ_T 	temperature
   nom_pb_C_H2 none
   nom_champ_C_H2 none
   nom_pb_C_O2 none
   nom_champ_C_O2 none
   nom_pb_C_H2O none
   nom_champ_C_H2O none
   nom_pb_psi pb_psi
   nom_champ_psi temperature
   nom_pb_phi pb_phi
   nom_champ_phi temperature
   i0_field_override champ_fonc_txyz dom_phi 1 (z>(-220e-6))*(30)+(z<(-220e-6))*(5e-06)
   Erev_field_override champ_fonc_txyz dom_phi 1 (z>(-220e-6))*(0.032)+(z<(-220e-6))*(1.14)
}
# Temperature problem is only here to provide a temperature field for the other equ. #
Read pb_T
{
	Conduction
	{
		equation_non_resolue 1
		diffusion { }
		initial_conditions { temperature Champ_Uniforme 1 357.0 }
		boundary_conditions {
            I_Periodic periodique
			defaultBC paroi_adiabatique
			I_GDLa_CHa paroi_adiabatique
			I_GDLc_CHc paroi_adiabatique
			I_CHa_Bipo paroi_adiabatique
			I_CHc_Bipo paroi_adiabatique
            I_Bipo_Cooling paroi_adiabatique
		}
	}
}

Read pb_phi
{
	Conduction
	{
	    equation_non_resolue 0
		diffusion { Tensor }
		initial_conditions { temperature Champ_Uniforme 1 -0.2 }
		boundary_conditions { defaultBC paroi_adiabatique }
    }
	Post_processing { fields dt_post 1e-8 { TEMPERATURE ELEM IR_ ELEM } }
    # Post_processing  { format lata fields dt_post 1e-8 {
      TEMPERATURE ELEM TEMPERATURE FACES
      ir_ FACES
    } } #
}

Read pb_psi
{
	Conduction {
        equation_non_resolue 0
        diffusion { Tensor }
        initial_conditions {
        	temperature champ_uniforme_morceaux dom_psi 1 {
                defaut 0.0
                dom_psi_CLc 0.3
                dom_psi_MPLc 0.3
                dom_psi_GDLc 0.3 }
        }
        boundary_conditions {
            I_Periodic periodique
            defaultBC paroi_adiabatique
            I_GDLa_Bipo  paroi_echange_externe_impose
               t_ext champ_front_uniforme 1 0.0
               h_imp champ_front_uniforme 1 1e9
            I_GDLc_Bipo  paroi_echange_externe_impose
               t_ext champ_front_uniforme 1 0.3
               h_imp champ_front_uniforme 1 1e9
        }
	}
	Post_processing	{ fields dt_post 1e-8 { TEMPERATURE ELEM } }
    # Post_processing  { format lata fields dt_post 1e-8 { TEMPERATURE ELEM TEMPERATURE FACES } } #
}

Solve pbc
End
